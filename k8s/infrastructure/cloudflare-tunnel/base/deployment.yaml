apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflared
spec:
  selector:
    matchLabels:
      app: cloudflared
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: cloudflared
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
    spec:
      terminationGracePeriodSeconds: 120
      containers:
        - name: cloudflared
          image: cloudflare/cloudflared:2025.4.0
          args:
            - "tunnel"
            - "--no-autoupdate"
            - "run"
            - "--token"
            - "$(TUNNEL_TOKEN)"
          env:
            - name: TUNNEL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: cloudflared-token
                  key: tunnel-token
            - name: TUNNEL_TRANSPORT_PROTOCOL
              value: "http2"
            - name: TUNNEL_RETRIES
              value: "10"
            - name: TUNNEL_GRACE_PERIOD
              value: "30s"
            - name: TUNNEL_ORIGIN_CERT
              value: "false"
            - name: TUNNEL_METRICS
              value: "0.0.0.0:2000"
          ports:
            - containerPort: 2000
              name: metrics
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /ready
              port: 2000
            failureThreshold: 5
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 2000
            failureThreshold: 10
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          startupProbe:
            httpGet:
              path: /ready
              port: 2000
            failureThreshold: 60
            initialDelaySeconds: 30
            periodSeconds: 10
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
            runAsUser: 65532
            runAsGroup: 65532
            allowPrivilegeEscalation: false
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 25m
              memory: 64Mi
